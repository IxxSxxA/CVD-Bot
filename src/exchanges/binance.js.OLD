// src/exchanges/binance.js
const WebSocket = require('ws');

class BinanceCVD {
  constructor() {
    this.cumulativeDelta = 0;
    this.wsUrl = 'wss://stream.binance.com:9443/ws';
    this.subscription = JSON.stringify({ method: 'SUBSCRIBE', params: ['btcusdt@trade'], id: 1 });
    this.connect();
  }

  connect() {
    this.ws = new WebSocket(this.wsUrl);

    this.ws.on('open', () => {
      console.log('Connessione WebSocket Binance aperta');
      this.ws.send(this.subscription);
    });

    this.ws.on('message', (data) => {
      try {
        const parsedData = JSON.parse(data);
        if (parsedData.e === 'trade' && parsedData.s === 'BTCUSDT') {
          const volume = parseFloat(parsedData.q);
          const side = parsedData.m ? 'Sell' : 'Buy'; // m = true significa vendita aggressiva
          const delta = side === 'Buy' ? volume : -volume;
          this.cumulativeDelta += delta;
          console.log(`Binance - Trade: ${side}, Volume: ${volume}, CVD: ${this.cumulativeDelta}`);
        }
      } catch (error) {
        console.error('Errore parsing messaggio WebSocket Binance:', error);
      }
    });

    this.ws.on('error', (error) => console.error('Errore WebSocket Binance:', error));
    this.ws.on('close', () => {
      console.log('Connessione WebSocket Binance chiusa. Riconnessione...');
      setTimeout(() => this.connect(), 5000);
    });
  }

  getCVD() {
    return this.cumulativeDelta;
  }

  resetCVD() {
    this.cumulativeDelta = 0;
  }
}

module.exports = BinanceCVD;